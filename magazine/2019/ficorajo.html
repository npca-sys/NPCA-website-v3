<!DOCTYPE html>
<html lang="ja">
<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-4970457-1"></script>
  <script>
    if (document.domain === 'www.npca.jp') {
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-4970457-1');
    }
  </script>

  <meta charset="UTF-8" />
  <link rel="stylesheet" type="text/css" href="style.css" />
<link rel="next" title="UnityのAIを使って…" href="Hiro.html"><link rel="prev" title="Blenderで簡単モデリング！" href="sarugami.html">  <meta name="generator" content="Re:VIEW" />
  <title>C#でファイルを暗号化する | NPCA部誌2019</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.10.1/dist/katex.min.css" integrity="sha384-dbVIfZGuN1Yq7/1Ocstc1lUEm+AT+/rCkibIcC/OmWo5f0EA48Vf8CytHzGrSwbQ" crossorigin="anonymous">
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.10.1/dist/katex.min.js" integrity="sha384-2BKqo+exmr9su6dir+qCw08N2ZKRucY4PrGQPPWU1A7FtlCGjmEGFqXCv5nyM5Ij" crossorigin="anonymous"></script>
</head>
<body>
  <div class="book">
    <nav class="side-content">
      <h1>NPCA部誌2019</h1>
      <ul class="book-toc">
<li><a href="index.html">TOP</a></li>
<li><a href="predef.html">前書き</a></li>
<li><a href="object_1037.html">1 JINS MEMEで美少女になる話</a></li>
<li><a href="sashiming.html">2 Google Apps ScriptでTwitter botを作ってみる</a></li>
<li><a href="sarugami.html">3 Blenderで簡単モデリング！</a></li>
<li><a href="ficorajo.html">4 C#でファイルを暗号化する</a></li>
<li><a href="Hiro.html">5 UnityのAIを使って…</a></li>
<li><a href="motty.html">6 Atomで快適なプログラミング環境を構築してみる</a></li>
<li><a href="takepan.html">7 iPhoneを使ってお手軽VR</a></li>
<li><a href="kuro.html">8 Windowsのショートカットキーについて</a></li>
<li><a href="kusafukakota.html">9 Gmailの活用術</a></li>
<li><a href="2lu3.html">10 未踏ジュニアとLifeWatcher</a></li>
<li><a href="harady.html">11 グラフのおはなし</a></li>
<li><a href="cobalt.html">12 C#の布教</a></li>
<li><a href="RLtdExp.html">13 プログラマー歴実質1年の僕がWindowsとC++でプログラミングをしたかった話</a></li>
<li><a href="mafusuke.html">14 Pythonの高速化について</a></li>
<li><a href="neko.html">15 Siv3Dでゲームを作る</a></li>
<li><a href="uraoz.html">16 明日(半年後)から始めるVRChat</a></li>
<li><a href="hinata.html">17 NPCAの部誌執筆を支える技術</a></li>
<li><a href="postdef.html">編集後記</a></li>
</ul>
      <p class="review-signature">powered by <a href="http://reviewml.org/">Re:VIEW</a></p>
    </nav>
    <div class="book-body">
      <header>
      </header>
      <div class="book-page">
        <h1><a id="h4"></a><span class="secno">第4章　</span>C#でファイルを暗号化する</h1>
<p><p style="text-align:right">75回生 ficorajo</p></p>

<h2><a id="h4-1"></a><span class="secno">4.1　</span>前書き</h2>

<h3><a id="h4-1-1"></a>挨拶</h3>
<p>こんにちは、75回生のficorajoです。</p>
<p>中三になったということで、初めて部誌を書くことになりました。</p>
<p>拙い文章ですが、最後まで読んでいただけたら幸いです。</p>

<h3><a id="h4-1-2"></a>情報を守るうえで重要なもの</h3>
<p>みなさんは、パソコンを使ったことがあるでしょうか？</p>
<p>パソコンは、フォルダーから階層構造として情報を管理しています。そして、自分が何かまとまった一つのテーマの物のファイルを、フォルダに格納しています。そして、我々がパソコンに侵入されたりした場合にファイルへの攻撃を防ぐには、ファイルを暗号化することが必要です。ということで、、早速暗号化していきましょう。</p>

<h2><a id="h4-2"></a><span class="secno">4.2　</span>前準備</h2>
<p>今回はファイルを暗号化するプログラムを書くのに、Visual Studioというのを使っていきます。理由としては、Microsoft社が推進する.NETシリーズとの相性が非常に良いからです。(そもそも同じ会社が作っているので当たり前)では、Visual Studioをインストールしていくのですが、まず、<a href="https://bit.ly/2J5WDWj" class="link">ここ</a>から、コミュニティのバージョンを選択して、 <a href="https://bit.ly/2GSjgw2" class="link">これ</a>の通りに進めてください。これで、前準備は完了です。</p>

<h2><a id="h4-3"></a><span class="secno">4.3　</span>C# -&gt; NET</h2>
<p>まず、.NETのコードを書く前に、.NETのコードの基礎知識について書いていきたいと思います。</p>

<h3><a id="h4-3-1"></a>オブジェクト指向言語</h3>
<p>.NETの開発標準言語であるC#などは、オブジェクト指向言語と呼ばれます。オブジェクト指向言語のベースとなっているオブジェクト指向とは、実世界を模倣して構築された世界観のことです。オブジェクト指向とは、分かれて存在する＜オブジェクト＞同士が＜やりとり＞を行うことで、何らかの行為が実現するという世界観を、プログラミングの世界に持ち込むことを指向する(=目指す)ことです。そして、これを言語に取り込んだものを、オブジェクト指向言語といいます。</p>

<h3><a id="h4-3-2"></a>オブジェクト指向の要素</h3>
<p>オブジェクト指向には、次の二つの要素が存在します。</p>
<ol>
<li>オブジェクト</li>
<li>オブジェクトを分類する境界</li>
</ol>
<p>現実世界で例えれば、セールスの人が家に来て、前田ですと言われても、NHKか、教団の人か、Wi-Fiの業者かは、言われなければわかりません。これにおける前田さんがオブジェクト、NHK, 教団, Wi-Fiの業者それぞれを分類するものが、オブジェクトを分類する境界ということです。C#の世界では、オブジェクトは「クラス」、オブジェクト指向を分類するものは「名前空間」と定義されます。</p>

<h3><a id="h4-3-3"></a>ひな形コード</h3>
<p>まず、ここまでのことを受けて、実際に少し書いてみましょう。</p>
<div id="hiina" class="image">
<img src="images/ficorajo/hiina.png" alt="雛形コード" class="width-060per" />
<p class="caption">
図4.1: 雛形コード
</p>
</div>
<p>先ほど言った通り、オブジェクト指向を分類する境界は名前空間、namespaceと呼ばれ、オブジェクト指向はクラス、classと定義され、表されます。当然ですが名前空間とクラスには、始まりと終わりがあります。その間はスコープと呼ばれ、始まり終わりを{}と表します。そして、この　System.Windows.Forms.Formは、.NETのライブラリに用意されたクラスです。ここにおいて、把握しておいてほしいことがあります。ソースコードはただの設計図なだけで、本体ではないということです。本体は、System.Windows.Forms.Formなだけです。</p>

<h2><a id="h4-4"></a><span class="secno">4.4　</span>暗号化前夜</h2>
<p>さて、終わりが近づいてきました。もうすぐで、暗号化の部分に入りますが、もうしばらく、我慢してお読みください。</p>

<h3><a id="h4-4-1"></a>AESとは</h3>
<p>まず、AESとは、Advanced Encryption Standerd の略で、アメリカ国立標準技術研究所(NIST)による、厳しい選定審査によって選ばれた、オープンな暗号アルゴリズムです。米国で生まれましたが、Standerdとある通り、世界標準といっても過言ではないようになっています。現時点で、公開されながら大きな脆弱性もなく、共通鍵暗号方式ではAES一択と言っていいでしょう。</p>

<h3><a id="h4-4-2"></a>パディング</h3>
<p>先ほど述べられたAESは128bit(16ビット)で暗号化されます。が、この16ビットで割り切れないサイズのファイルを暗号化する場合に、復号するタイミングで問題が発生します。その理由は、元のファイルのサイズが分からなくなってしまうからです。そこでブロック暗号には、暗号化モードに加えパディングモードを指定する必要があります。普通ならいちいち実装しなければならないのですが、.NETが用意してくれており、わざわざ実装する必要はありません。いろいろなパディングモードがありますが、今回はPaddingMode.PKCS7を使うこととしましょう。</p>

<h2><a id="h4-5"></a><span class="secno">4.5　</span>暗号化</h2>
<p>パディングモードについての説明が終わったところで、実際に暗号化していきましょう。</p>
<div id="source-code" class="code">
<p class="caption">リスト4.2: 暗号化コード</p>
<table class="highlight rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
</pre></td><td class="rouge-code"><pre>  <span class="k">private</span> <span class="kt">bool</span> <span class="nf">FileEncrypt</span><span class="p">(</span><span class="kt">string</span> <span class="n">FilePath</span><span class="p">,</span> <span class="kt">string</span> <span class="n">Password</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">System</span><span class="p">.</span><span class="n">Diagnostics</span><span class="p">.</span><span class="n">Stopwatch</span> <span class="n">sw</span> <span class="p">=</span> <span class="k">new</span> <span class="n">System</span><span class="p">.</span><span class="n">Diagnostics</span><span class="p">.</span><span class="nf">Stopwatch</span><span class="p">();</span>
    <span class="n">sw</span><span class="p">.</span><span class="nf">Start</span><span class="p">();</span>

    <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">len</span><span class="p">;</span>
    <span class="kt">byte</span><span class="p">[]</span> <span class="n">buffer</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="p">[</span><span class="m">4096</span><span class="p">];</span>

    <span class="c1">//Output file path.</span>
    <span class="kt">string</span> <span class="n">OutFilePath</span> <span class="p">=</span> <span class="n">Path</span><span class="p">.</span><span class="nf">Combine</span><span class="p">(</span><span class="n">Path</span><span class="p">.</span><span class="nf">GetDirectoryName</span><span class="p">(</span><span class="n">FilePath</span><span class="p">),</span> <span class="n">Path</span><span class="p">.</span><span class="nf">GetFileNameWithoutExtension</span><span class="p">(</span><span class="n">FilePath</span><span class="p">))</span> <span class="p">+</span> <span class="s">".enc"</span><span class="p">;</span>

    <span class="k">using</span> <span class="p">(</span><span class="n">FileStream</span> <span class="n">outfs</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">FileStream</span><span class="p">(</span><span class="n">OutFilePath</span><span class="p">,</span> <span class="n">FileMode</span><span class="p">.</span><span class="n">Create</span><span class="p">,</span> <span class="n">FileAccess</span><span class="p">.</span><span class="n">Write</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="k">using</span> <span class="p">(</span><span class="n">AesManaged</span> <span class="n">aes</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">AesManaged</span><span class="p">())</span>
        <span class="p">{</span>
            <span class="n">aes</span><span class="p">.</span><span class="n">BlockSize</span> <span class="p">=</span> <span class="m">128</span><span class="p">;</span>              <span class="c1">// BlockSize = 16bytes</span>
            <span class="n">aes</span><span class="p">.</span><span class="n">KeySize</span> <span class="p">=</span> <span class="m">128</span><span class="p">;</span>                <span class="c1">// KeySize = 16bytes</span>
            <span class="n">aes</span><span class="p">.</span><span class="n">Mode</span> <span class="p">=</span> <span class="n">CipherMode</span><span class="p">.</span><span class="n">CBC</span><span class="p">;</span>        <span class="c1">// CBC mode</span>
            <span class="n">aes</span><span class="p">.</span><span class="n">Padding</span> <span class="p">=</span> <span class="n">PaddingMode</span><span class="p">.</span><span class="n">PKCS7</span><span class="p">;</span>    <span class="c1">// Padding mode is "PKCS7".</span>

            <span class="n">Rfc2898DeriveBytes</span> <span class="n">deriveBytes</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Rfc2898DeriveBytes</span><span class="p">(</span><span class="n">Password</span><span class="p">,</span> <span class="m">16</span><span class="p">);</span>
            <span class="kt">byte</span><span class="p">[]</span> <span class="n">salt</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="p">[</span><span class="m">16</span><span class="p">];</span>
            <span class="n">salt</span> <span class="p">=</span> <span class="n">deriveBytes</span><span class="p">.</span><span class="n">Salt</span><span class="err">；</span>
            <span class="kt">byte</span><span class="p">[]</span> <span class="n">bufferKey</span> <span class="p">=</span> <span class="n">deriveBytes</span><span class="p">.</span><span class="nf">GetBytes</span><span class="p">(</span><span class="m">16</span><span class="p">);</span>

            <span class="cm">/*
            byte[] bufferKey = new byte[16];
            byte[] bufferPassword = Encoding.UTF8.GetBytes(Password);
            for (i = 0; i &lt; bufferKey.Length; i++)
            {
                if (i &lt; bufferPassword.Length)
                {
                    bufferKey[i] = bufferPassword[i];
                }
                else
                {
                    bufferKey[i] = 0;
                }
            */</span>

            <span class="n">aes</span><span class="p">.</span><span class="n">Key</span> <span class="p">=</span> <span class="n">bufferKey</span><span class="p">;</span>
            <span class="c1">// IV ( Initilization Vector ) は、AesManagedにつくらせる</span>
            <span class="n">aes</span><span class="p">.</span><span class="nf">GenerateIV</span><span class="p">();</span>

            <span class="c1">//Encryption interface.</span>
            <span class="n">ICryptoTransform</span> <span class="n">encryptor</span> <span class="p">=</span> <span class="n">aes</span><span class="p">.</span><span class="nf">CreateEncryptor</span><span class="p">(</span><span class="n">aes</span><span class="p">.</span><span class="n">Key</span><span class="p">,</span> <span class="n">aes</span><span class="p">.</span><span class="n">IV</span><span class="p">);</span>

            <span class="k">using</span> <span class="p">(</span><span class="n">CryptoStream</span> <span class="n">cse</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">CryptoStream</span><span class="p">(</span><span class="n">outfs</span><span class="p">,</span> <span class="n">encryptor</span><span class="p">,</span> <span class="n">CryptoStreamMode</span><span class="p">.</span><span class="n">Write</span><span class="p">))</span>
            <span class="p">{</span>
              <span class="n">outfs</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="n">salt</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">16</span><span class="p">);</span>
              <span class="n">outfs</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="n">aes</span><span class="p">.</span><span class="n">IV</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">16</span><span class="p">);</span>
                <span class="k">using</span> <span class="p">(</span><span class="n">DeflateStream</span> <span class="n">ds</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">DeflateStream</span><span class="p">(</span><span class="n">cse</span><span class="p">,</span> <span class="n">CompressionMode</span><span class="p">.</span><span class="n">Compress</span><span class="p">))</span> <span class="c1">//圧縮</span>
                <span class="p">{</span>
                    <span class="k">using</span> <span class="p">(</span><span class="n">FileStream</span> <span class="n">fs</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">FileStream</span><span class="p">(</span><span class="n">FilePath</span><span class="p">,</span> <span class="n">FileMode</span><span class="p">.</span><span class="n">Open</span><span class="p">,</span> <span class="n">FileAccess</span><span class="p">.</span><span class="n">Read</span><span class="p">))</span>
                    <span class="p">{</span>
                        <span class="k">while</span> <span class="p">((</span><span class="n">len</span> <span class="p">=</span> <span class="n">fs</span><span class="p">.</span><span class="nf">Read</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">4096</span><span class="p">))</span> <span class="p">&gt;</span> <span class="m">0</span><span class="p">)</span>
                        <span class="p">{</span>
                            <span class="n">ds</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">sw</span><span class="p">.</span><span class="nf">Stop</span><span class="p">();</span>
    <span class="kt">long</span> <span class="n">resultTime</span> <span class="p">=</span> <span class="n">sw</span><span class="p">.</span><span class="n">ElapsedMilliseconds</span><span class="p">;</span>

    <span class="n">textBox1</span><span class="p">.</span><span class="nf">AppendText</span><span class="p">(</span><span class="s">"暗号化成功: "</span> <span class="p">+</span> <span class="n">Path</span><span class="p">.</span><span class="nf">GetFileName</span><span class="p">(</span><span class="n">OutFilePath</span><span class="p">)</span> <span class="p">+</span> <span class="n">Environment</span><span class="p">.</span><span class="n">NewLine</span><span class="p">);</span>
    <span class="n">textBox1</span><span class="p">.</span><span class="nf">AppendText</span><span class="p">(</span><span class="s">"実行時間: "</span> <span class="p">+</span> <span class="n">resultTime</span><span class="p">.</span><span class="nf">ToString</span><span class="p">()</span> <span class="p">+</span> <span class="s">"ms"</span><span class="p">);</span>

    <span class="k">return</span> <span class="p">(</span><span class="k">true</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table>
</div>
<p>これが暗号化です。見ていきましょう。まず、<code class="inline-code tt">System.Diagnostics.Stopwatch</code>は、ストップウォッチとある通りストップウォッチを開始させるものです。そして、<code class="inline-code tt">aes.Mode = CipherMode.CBC</code>で、暗号化モードをCBCモードとしています。さらに、<code class="inline-code tt">aes.Padding = PaddingMode.PKCS7</code>でパディングモードを設定します。また、<code class="inline-code tt">Rfc2898DeriveBytes deriveBytes = new Rfc2898DeriveBytes(Password, 16)</code>で、入力されたパスをもとに乱数で暗号を設定し、<code class="inline-code tt">byte[] salt = new byte[16]</code>で、自動取得されたソルトを取得するようになっています。そして、  <code class="inline-code tt">outfs.Write(salt, 0, 16)  outfs.Write(aes.IV, 0, 16)</code>でソルトを埋め込み、<code class="inline-code tt">textBox1.AppendText(&quot;暗号化成功: &quot; + Path.GetFileName(OutFilePath) + Environment.NewLine)</code>で、暗号化が完了します。やったね。</p>

<h2><a id="h4-6"></a><span class="secno">4.6　</span>復号</h2>
<p>暗号化するのであれば、復号化できなければ意味がありません。</p>
<div id="source-code" class="code">
<p class="caption">リスト4.2: 復号化コード</p>
<table class="highlight rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
</pre></td><td class="rouge-code"><pre>  <span class="k">private</span> <span class="kt">bool</span> <span class="nf">FileDecrypt</span><span class="p">(</span><span class="kt">string</span> <span class="n">FilePath</span><span class="p">,</span> <span class="kt">string</span> <span class="n">Password</span><span class="p">)</span>
  <span class="p">{</span>
      <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">len</span><span class="p">;</span>
      <span class="kt">byte</span><span class="p">[]</span> <span class="n">buffer</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="p">[</span><span class="m">4096</span><span class="p">];</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">String</span><span class="p">.</span><span class="nf">Compare</span><span class="p">(</span><span class="n">Path</span><span class="p">.</span><span class="nf">GetExtension</span><span class="p">(</span><span class="n">FilePath</span><span class="p">),</span> <span class="s">".enc"</span><span class="p">,</span> <span class="k">true</span><span class="p">)</span> <span class="p">!=</span> <span class="m">0</span><span class="p">)</span>
      <span class="p">{</span>
          <span class="c1">//The file are not encrypted file! Decryption failed</span>
          <span class="n">MessageBox</span><span class="p">.</span><span class="nf">Show</span><span class="p">(</span><span class="s">"暗号化されたファイルではありません！"</span> <span class="p">+</span> <span class="n">Environment</span><span class="p">.</span><span class="n">NewLine</span> <span class="p">+</span> <span class="s">"復号に失敗しました。"</span><span class="p">,</span>
              <span class="s">"Error"</span><span class="p">,</span> <span class="n">MessageBoxButtons</span><span class="p">.</span><span class="n">OK</span><span class="p">,</span> <span class="n">MessageBoxIcon</span><span class="p">.</span><span class="n">Exclamation</span><span class="p">);</span>
          <span class="k">return</span> <span class="p">(</span><span class="k">false</span><span class="p">);</span> <span class="p">;</span>
      <span class="p">}</span>

      <span class="c1">//Output file path.</span>
      <span class="kt">string</span> <span class="n">OutFilePath</span> <span class="p">=</span> <span class="n">Path</span><span class="p">.</span><span class="nf">Combine</span><span class="p">(</span><span class="n">Path</span><span class="p">.</span><span class="nf">GetDirectoryName</span><span class="p">(</span><span class="n">FilePath</span><span class="p">),</span> <span class="n">Path</span><span class="p">.</span><span class="nf">GetFileNameWithoutExtension</span><span class="p">(</span><span class="n">FilePath</span><span class="p">))</span> <span class="p">+</span> <span class="s">".txt"</span><span class="p">;</span>

      <span class="k">using</span> <span class="p">(</span><span class="n">FileStream</span> <span class="n">outfs</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">FileStream</span><span class="p">(</span><span class="n">OutFilePath</span><span class="p">,</span> <span class="n">FileMode</span><span class="p">.</span><span class="n">Create</span><span class="p">,</span> <span class="n">FileAccess</span><span class="p">.</span><span class="n">Write</span><span class="p">))</span>
      <span class="p">{</span>
          <span class="k">using</span> <span class="p">(</span><span class="n">FileStream</span> <span class="n">fs</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">FileStream</span><span class="p">(</span><span class="n">FilePath</span><span class="p">,</span> <span class="n">FileMode</span><span class="p">.</span><span class="n">Open</span><span class="p">,</span> <span class="n">FileAccess</span><span class="p">.</span><span class="n">Read</span><span class="p">))</span>
          <span class="p">{</span>
              <span class="k">using</span> <span class="p">(</span><span class="n">AesManaged</span> <span class="n">aes</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">AesManaged</span><span class="p">())</span>
              <span class="p">{</span>
                  <span class="n">aes</span><span class="p">.</span><span class="n">BlockSize</span> <span class="p">=</span> <span class="m">128</span><span class="p">;</span>              <span class="c1">// BlockSize = 16bytes</span>
                  <span class="n">aes</span><span class="p">.</span><span class="n">KeySize</span> <span class="p">=</span> <span class="m">128</span><span class="p">;</span>                <span class="c1">// KeySize = 16bytes</span>
                  <span class="n">aes</span><span class="p">.</span><span class="n">Mode</span> <span class="p">=</span> <span class="n">CipherMode</span><span class="p">.</span><span class="n">CBC</span><span class="p">;</span>        <span class="c1">// CBC mode</span>
                  <span class="n">aes</span><span class="p">.</span><span class="n">Padding</span> <span class="p">=</span> <span class="n">PaddingMode</span><span class="p">.</span><span class="n">PKCS7</span><span class="p">;</span>    <span class="c1">// Padding mode is "PKCS7".</span>

                  <span class="c1">// salt</span>
                  <span class="kt">byte</span><span class="p">[]</span> <span class="n">salt</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="p">[</span><span class="m">16</span><span class="p">];</span>
                  <span class="n">fs</span><span class="p">.</span><span class="nf">Read</span><span class="p">(</span><span class="n">salt</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">16</span><span class="p">);</span>

                  <span class="c1">// Initilization Vector</span>
                  <span class="kt">byte</span><span class="p">[]</span> <span class="n">iv</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="p">[</span><span class="m">16</span><span class="p">];</span>
                  <span class="n">fs</span><span class="p">.</span><span class="nf">Read</span><span class="p">(</span><span class="n">iv</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">16</span><span class="p">);</span>
                  <span class="n">aes</span><span class="p">.</span><span class="n">IV</span> <span class="p">=</span> <span class="n">iv</span><span class="p">;</span>

                  <span class="cm">/*

                  byte[] bufferKey = new byte[16];
                  byte[] bufferPassword = Encoding.UTF8.GetBytes(Password);
                  for (i = 0; i &lt; bufferKey.Length; i++)
                  {
                      if (i &lt; bufferPassword.Length)
                      {
                          bufferKey[i] = bufferPassword[i];
                      }
                      else
                      {
                          bufferKey[i] = 0;
                      }
                  */</span>
                  <span class="n">Rfc2898DeriveBytes</span> <span class="n">deriveBytes</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Rfc2898DeriveBytes</span><span class="p">(</span><span class="n">Password</span><span class="p">,</span> <span class="n">salt</span><span class="p">);</span>
                  <span class="kt">byte</span><span class="p">[]</span> <span class="n">bufferKey</span> <span class="p">=</span> <span class="n">deriveBytes</span><span class="p">.</span><span class="nf">GetBytes</span><span class="p">(</span><span class="m">16</span><span class="p">);</span>
                  <span class="n">aes</span><span class="p">.</span><span class="n">Key</span> <span class="p">=</span> <span class="n">bufferKey</span><span class="p">;</span>

                  <span class="c1">//Decryption interface.</span>
                  <span class="n">ICryptoTransform</span> <span class="n">decryptor</span> <span class="p">=</span> <span class="n">aes</span><span class="p">.</span><span class="nf">CreateDecryptor</span><span class="p">(</span><span class="n">aes</span><span class="p">.</span><span class="n">Key</span><span class="p">,</span> <span class="n">aes</span><span class="p">.</span><span class="n">IV</span><span class="p">);</span>

                  <span class="k">using</span> <span class="p">(</span><span class="n">CryptoStream</span> <span class="n">cse</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">CryptoStream</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span> <span class="n">decryptor</span><span class="p">,</span> <span class="n">CryptoStreamMode</span><span class="p">.</span><span class="n">Read</span><span class="p">))</span>
                  <span class="p">{</span>
                      <span class="k">using</span> <span class="p">(</span><span class="n">DeflateStream</span> <span class="n">ds</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">DeflateStream</span><span class="p">(</span><span class="n">cse</span><span class="p">,</span> <span class="n">CompressionMode</span><span class="p">.</span><span class="n">Decompress</span><span class="p">))</span>
                      <span class="p">{</span>
                          <span class="k">while</span> <span class="p">((</span><span class="n">len</span> <span class="p">=</span> <span class="n">ds</span><span class="p">.</span><span class="nf">Read</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">4096</span><span class="p">))</span> <span class="p">&gt;</span> <span class="m">0</span><span class="p">)</span>
                          <span class="p">{</span>
                              <span class="n">outfs</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
                          <span class="p">}</span>
                      <span class="p">}</span>
                  <span class="p">}</span>
              <span class="p">}</span>
          <span class="p">}</span>
      <span class="p">}</span>
      <span class="c1">//Decryption succeed.</span>
      <span class="n">textBox1</span><span class="p">.</span><span class="nf">AppendText</span><span class="p">(</span><span class="s">"復号成功: "</span> <span class="p">+</span> <span class="n">Path</span><span class="p">.</span><span class="nf">GetFileName</span><span class="p">(</span><span class="n">OutFilePath</span><span class="p">)</span> <span class="p">+</span> <span class="n">Environment</span><span class="p">.</span><span class="n">NewLine</span><span class="p">);</span>
      <span class="k">return</span> <span class="p">(</span><span class="k">true</span><span class="p">);</span>
  <span class="p">}</span>
</pre></td></tr></tbody></table>
</div>
<p>同じくです。見たら気づくかもしれませんが、暗号化する前に行われた圧縮を解除するための解凍作業(<code class="inline-code tt">using (CryptoStream cse = new CryptoStream(fs, decryptor, CryptoStreamMode.Read))</code>)以外は、暗号化コードを逆向きにさせたようなものです。</p>
<p>*このコードは、Mitsuhiro HibaraさんのMITライセンスであることをここに記します。</p>

<h2><a id="h4-7"></a><span class="secno">4.7　</span>最後に</h2>
<p>いかがでしたでしょうか。拙い文でしたが最後まで読んでいただきありがとうございました。</p>
      </div>
      <div class="navs">
        <nav class="book-navi book-prev">
                    <a href="sarugami.html">
            <div class="book-cursor"><span class="cursor-prev">◀ Blenderで簡単モデリング！</span></div>
          </a>
                  </nav>
        <nav class="book-navi book-next">
                    <a href="Hiro.html">
            <div class="book-cursor"><span class="cursor-next">▶ UnityのAIを使って…</span></div>
          </a>
                  </nav>
      </div>
    </div>
  </div>
  <footer>
      </footer>
  <script>
    (function() {
      if (!window.katex) { return; }
      var equations = [].slice.call(document.querySelectorAll(".equation"));
      for (var i = 0; i < equations.length; i++) {
        katex.render(equations[i].textContent, equations[i]);
      }
    }) ();
  </script>
</body>
</html>
